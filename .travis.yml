# travis.yml validator
# https://lint.travis-ci.org/klezm/delete2

# https://github.com/travis-ci/travis-ci/issues/2856#issuecomment-58609666
# with an empty .travis.yml   nothing works
# with only a script step     we assume ruby
# with language: generic      only the script step runs
# with language: c we set CC=gcc and run gcc --version, which is minimal, but still more than nothing

# https://loiane.com/2017/09/continuous-integration-with-angular-cli-travis-ci-firebase-greenkeeper-github/
# https://caveofcode.com/2017/05/publish-an-angular-app-to-github-pages/amp/

# https://medium.com/@cpavnn/deploy-to-firebase-hosting-from-github-3772fed05e72
# https://coryrylan.com/blog/deploy-angular-cli-apps-to-firebase

# since travis interprets the windows newline as newline + '\n\ make sure the new lines are LF = \n and not CR LF = \r\n
# https://de.wikipedia.org/wiki/Zeilenumbruch#ASCII_und_EBCDIC
# to avoid that create .gitattributes with the line '.travis.yml  eol=lf'

language: node_js

node_js:
   - node # will use latest node

branches:
    only:
      - prototype
      - master
# +    - /^greenkeeper/.*$/

cache:
  directories:
    - node_modules

before_script: # commands to run before the build step
#   - npm install -g --silent @angular/cli
#   - npm install -g @angular/cli
#   - npm install --save @angular/material @angular/cdk
#   - npm install --save @angular/animations
#   - npm install @angular/flex-layout --save
   - npm install

script: # the build step
#   - npm run build.prod
   - ng build --prod --base-href "https://physikonline-ffm.github.io/tinyGU/"
#   - MY_404_TITLE="TinyGU 404 redirect page"
#     && MY_REPOSITORY_NAME="tinyGU"
#     && curl https://gist.githubusercontent.com/klezm/ac3121fbc85ecdedd59b440b551dd02a/raw/bdd088adb49095b1a68ee9be4be4d6512b76e3b8/404.html
#     | sed -e "s/404_TITLE/$MY_404_TITLE/g; s/REPOSITORY_NAME/$MY_REPOSITORY_NAME/g"
#     > dist/404.html
#     && cat dist/404.html

before_deploy: >

  # SET YOUR VARIABLES!;

  MY_404_TITLE="TinyGU 404 redirect page";                                          # the title of the error page;
  MY_REPOSITORY_NAME="tinyGU";                                                      # name of the repository (to set the redirect link);
  GIST_ERROR_PAGE="https://gist.github.com/ac3121fbc85ecdedd59b440b551dd02a.git";   # the 404.html you want to use, saved as gist;

  GIST_FOLDER=$(basename -s .git "$GIST_ERROR_PAGE");
  echo "##################################################################################";
  echo "$GIST_FOLDER";
  ls -lha;
  ls -lha dist/;
  ls -R ../ > dist/ls1.txt;

  git clone --progress "$GIST_ERROR_PAGE" /dist/ac3121fbc85ecdedd59b440b551dd02a; # "dist/$GIST_FOLDER";
  ls -lha;
  ls -lha dist/;
  ls -R ../ > dist/ls2.txt;

  mv "$GIST_FOLDER"/404.html dist/;
  ls -lha;
  ls -lha dist/;
  ls -R ../ > dist/ls3.txt;

  rm -rf "$GIST_FOLDER";
  ls -lha;
  ls -lha dist/;
  ls -R ../ > dist/ls4.txt;

  sed -i -e "s/404_TITLE/$MY_404_TITLE/g; s/REPOSITORY_NAME/$MY_REPOSITORY_NAME/g" dist/404.html;
  ls -lha;
  ls -lha dist/;
  ls -R ../ > dist/ls5.txt;


# before_deploy:
# http://www.backalleycoder.com/2016/05/13/sghpa-the-single-page-app-hack-for-github-pages/
# https://stackoverflow.com/questions/5411538/redirect-from-an-html-page
# wget -O $TRAVIS_BUILD_DIR gist to /dist + replace REPO_NAME in 404.html

# get https://gist.github.com/ac3121fbc85ecdedd59b440b551dd02a.git
#   - wget -O $TRAVIS_BUILD_DIR https://gist.githubusercontent.com/klezm/ac3121fbc85ecdedd59b440b551dd02a/raw/bdd088adb49095b1a68ee9be4be4d6512b76e3b8/404.html
# https://stackoverflow.com/questions/13210880/replace-one-substring-for-another-string-in-shell-script
# https://stackoverflow.com/questions/2871181/replacing-some-characters-in-a-string-with-another-character
# https://stackoverflow.com/questions/47228723/how-to-pass-to-curl-file-with-replace-some-sequence
# http://tldp.org/LDP/abs/html/string-manipulation.html
# https://github.com/travis-ci/travis-ci/issues/2856#issuecomment-58609666
# https://github.com/codecov/example-bash/blob/master/.travis.yml
# https://www.ortussolutions.com/blog/build-test-and-deploy-your-module-with-travis-ci


deploy:
  provider: pages
  skip_cleanup: true
  github_token: $GITHUB_TOKEN # Set in travis-ci.org dashboard
  local_dir: dist
  file:
  on:
#    branch: master
    all_branches: true

notifications:
  email: false
  slack:  # <USER>:<TOKEN>#<CHANNEL>
    rooms:
      # https://travis-encrypt.github.io/
      # travis encrypt "<account>:<token>" --add notifications.slack -r <accountName>/<repoName>
      # travis encrypt "<account>:<token>#<channel>" --add notifications.slack.rooms -r <accountName>/<repoName>
      secure: "ENCRYPTED_KEY"
      on_start: always
      on_failure: always
      on_success: always
      on_cancel: always
      on_error: always
      on_pull_requests: always
